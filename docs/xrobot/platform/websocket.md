---
title: WebSocket åè®®
---

# WebSocket åè®®

## åè®®ä»‹ç»

WebSocket æ˜¯ä¸€ç§ç½‘ç»œé€šä¿¡åè®®ï¼Œæä¾›äº†å…¨åŒå·¥é€šä¿¡é€šé“ï¼Œå…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œå®æ—¶æ•°æ®äº¤æ¢ã€‚ä¸ä¼ ç»Ÿçš„ HTTP è¯·æ±‚-å“åº”æ¨¡å‹ä¸åŒï¼ŒWebSocket å…è®¸åœ¨å•ä¸ªè¿æ¥ä¸Šè¿›è¡ŒåŒå‘é€šä¿¡ï¼Œè¿™ä½¿å¾—å®ƒéå¸¸é€‚åˆéœ€è¦å®æ—¶æ›´æ–°çš„åº”ç”¨åœºæ™¯ï¼Œå¦‚åœ¨çº¿èŠå¤©ã€å®æ—¶æ¸¸æˆå’Œé‡‘èäº¤æ˜“ç­‰ã€‚

- **å…¨åŒå·¥é€šä¿¡**ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥åŒæ—¶å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼Œå‡å°‘äº†å»¶è¿Ÿ
- **é•¿è¿æ¥**ï¼šä¸€æ—¦å»ºç«‹è¿æ¥ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥åœ¨ä¸é‡æ–°å»ºç«‹è¿æ¥çš„æƒ…å†µä¸‹è¿›è¡Œå¤šæ¬¡æ•°æ®äº¤æ¢
- **ä½å¼€é”€**ï¼šWebSocket è¿æ¥åœ¨å»ºç«‹åï¼Œæ•°æ®ä¼ è¾“çš„å¼€é”€è¾ƒå°ï¼Œé€‚åˆé¢‘ç¹çš„æ•°æ®äº¤æ¢


::: tip ç½‘ç»œè¦æ±‚
è¯·ç¡®ä¿åœ¨ä½¿ç”¨ WebSocket åè®®æ—¶ï¼Œè®¾å¤‡å·²è¿æ¥åˆ°ç¨³å®šçš„ç½‘ç»œï¼Œä»¥ç¡®ä¿æ•°æ®ä¼ è¾“çš„å¯é æ€§ã€‚
:::

## çµçŸ½AI WebSocket æœåŠ¡åœ°å€

**çµçŸ½AI** ä¸ºå…¼å®¹ä¸åŒèŠ¯ç‰‡ï¼ŒåŒæ—¶æ”¯æŒå®‰å…¨å’Œéå®‰å…¨è¿æ¥ï¼š

| åè®®ç±»å‹ | åœ°å€ | è¯´æ˜ |
|---------|------|------|
| **WSS** (æ¨è) | `wss://xrobo-io.qiniuapi.com/v1/ws/` | å®‰å…¨WebSocketè¿æ¥ï¼Œä½¿ç”¨SSL/TLSåŠ å¯† |
| **WS** | `ws://xrobo-io.qiniuapi.com/v1/ws/` | æ™®é€šWebSocketè¿æ¥ï¼Œé€‚ç”¨äºå†…éƒ¨ç½‘ç»œ |

::: warning åŠ¨æ€åœ°å€è·å–
WebSocket åœ°å€ä¹Ÿå¯ä»¥é€šè¿‡ [**OTAåè®®**](OTA.md) çš„è¿”å›åŠ¨æ€è·å¾—ï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨åŠ¨æ€è·å–çš„åœ°å€ã€‚
:::

## WebSocket é€šä¿¡æµç¨‹

### æ•´ä½“æµç¨‹æ¦‚è§ˆ

```mermaid
graph LR
    A[å»ºç«‹è¿æ¥] --> B[å‘é€Hello]
    B --> C[ç­‰å¾…Helloå“åº”]
    C --> D[å¼€å§‹ä¼šè¯]
    D --> E[æ¶ˆæ¯/éŸ³é¢‘äº¤äº’]
    E --> F[ç»“æŸä¼šè¯]
    F --> G[å…³é—­è¿æ¥]
```

- **ä¼šè¯å¼€å§‹**ï¼šè®¾å¤‡ç»ˆç«¯å»ºç«‹WebSocketè¿æ¥ â†’ å‘é€helloæ¶ˆæ¯ â†’ ç­‰å¾…æœåŠ¡ç«¯helloå“åº”
- **ä¼šè¯è¿›è¡Œ**ï¼šåŒå‘ä¼ è¾“æ¶ˆæ¯å’ŒéŸ³é¢‘æ•°æ®
- **ä¼šè¯ç»“æŸ**ï¼šè®¾å¤‡æˆ–æœåŠ¡ç«¯ä¸»åŠ¨å…³é—­WebSocketè¿æ¥

### æ­¥éª¤1ï¼šå»ºç«‹ WebSocket è¿æ¥

#### è¿æ¥åˆå§‹åŒ–

è®¾å¤‡å›ºä»¶æˆ–ç¡¬ä»¶ç»ˆç«¯SDKéœ€è¦ï¼š
1. åˆ›å»ºå¹¶åˆå§‹åŒ–WebSocketå®ä¾‹
2. å½“éœ€è¦å¼€å§‹è¯­éŸ³ä¼šè¯æ—¶ï¼Œæ„å»ºè¯·æ±‚å¤´å¹¶å»ºç«‹è¿æ¥

#### è¯·æ±‚å¤´æ„å»º

```c
// æ„å»ºwebsocketè¯·æ±‚å¤´
char extra_headers[1024];
sprintf(extra_headers, sizeof(extra_headers),
    "Pragma: no-cache\r\n"
    "Cache-Control: no-cache\r\n"
    "Authorization: Bearer %s\r\n"
    "Device-Id: %s\r\n"
    "Client-Id: %s\r\n"
    "Protocol-Version: 1", 
    g_ws_token, MAC, UUID);
```

#### å¿…éœ€çš„è¯·æ±‚å¤´å‚æ•°

| å‚æ•° | æ ¼å¼ | è¯´æ˜ |
|------|------|------|
| **Authorization** | `Bearer <token>` | è®¿é—®ä»¤ç‰Œï¼ŒæœåŠ¡ç«¯ç”¨äºèº«ä»½éªŒè¯ |
| **Protocol-Version** | `1` | åè®®ç‰ˆæœ¬å·ï¼Œéœ€ä¸helloæ¶ˆæ¯ä¸­versionå­—æ®µä¸€è‡´ |
| **Device-Id** | MACåœ°å€ | è®¾å¤‡ç‰©ç†ç½‘å¡MACåœ°å€ï¼ŒæœåŠ¡ç«¯éªŒè¯è®¾å¤‡ç»‘å®šçŠ¶æ€ |
| **Client-Id** | UUID | è½¯ä»¶ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ç¬¦ |

::: info è®¤è¯è¯´æ˜
è¿™äº›è¯·æ±‚å¤´éšWebSocketæ¡æ‰‹ä¸€èµ·å‘é€åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ ¹æ®éœ€æ±‚è¿›è¡Œæ ¡éªŒå’Œè®¤è¯ã€‚è®¾å¤‡éœ€è¦é¢„å…ˆåœ¨æœåŠ¡ç«¯æ³¨å†Œæˆ–ç»‘å®šæ™ºèƒ½ä½“æ‰èƒ½é€šè¿‡éªŒè¯ã€‚
:::

### æ­¥éª¤2ï¼šè®¾å¤‡å‘é€ Hello æ¶ˆæ¯

è¿æ¥æˆåŠŸåï¼Œè®¾å¤‡ç«¯å‘é€åˆå§‹åŒ–æ¶ˆæ¯å‘ŠçŸ¥æœåŠ¡å™¨åŸºæœ¬å‚æ•°ã€‚

#### OPUSæ ¼å¼Helloæ¶ˆæ¯

```json
{
  "type": "hello",
  "version": 1,
  "features": {
    "mcp": true  // æ”¯æŒMCPåè®®(ç‰©è”ç½‘æ§åˆ¶æ–°ä¸€ä»£åè®®)
  },
  "transport": "websocket",
  "audio_params": {
    "format": "opus",
    "sample_rate": 16000,
    "channels": 1,
    "frame_duration": 60,
    "play_buffer_duration": 1000
  }
}
```

#### PCMæ ¼å¼Helloæ¶ˆæ¯

```json
{
  "type": "hello",
  "version": 1,
  "features": {
    "mcp": true
  },
  "transport": "websocket",
  "audio_params": {
    "format": "pcm",
    "sample_rate": 16000,
    "channels": 1,
    "bit_depth": 16,
    "endianness": "little",
    "frame_duration": 20,
    "frame_size": 320,
    "sample_format": "signed_int16",
    "play_buffer_duration": 1000
  }
}
```

::: tip å­—æ®µè¯´æ˜
- **features**: å¯é€‰å­—æ®µï¼Œ`"mcp": true` è¡¨ç¤ºæ”¯æŒMCPåè®®è¿›è¡Œè®¾å¤‡èƒ½åŠ›å‘ç°å’Œå·¥å…·è°ƒç”¨
- **audio_params**: éŸ³é¢‘å‚æ•°é…ç½®ï¼Œæ”¯æŒOPUSå’ŒPCMä¸¤ç§æ ¼å¼
:::

### æ­¥éª¤3ï¼šæœåŠ¡å™¨Helloå“åº”

æœåŠ¡å™¨æ¥æ”¶åˆ°è®¾å¤‡çš„helloæ¶ˆæ¯åï¼Œè¿”å›ç¡®è®¤å“åº”ã€‚

#### æœåŠ¡å™¨Helloå“åº”æ ¼å¼

```json
{
  "type": "hello",
  "transport": "websocket",
  "session_id": "session_12345",  // ä¼šè¯æ ‡è¯†ç¬¦(å¯é€‰)
  "audio_params": {
    "format": "opus",
    "sample_rate": 16000,
    "channels": 1,
    "frame_duration": 60,
    "play_buffer_duration": 1000
  }
}
```

#### å“åº”éªŒè¯

| å¿…éœ€å­—æ®µ | è¯´æ˜ |
|----------|------|
| `type` | å¿…é¡»ä¸º "hello" |
| `transport` | å¿…é¡»ä¸º "websocket" |
| `session_id` | ä¼šè¯æ ‡è¯†ç¬¦(å¯é€‰)ï¼Œè®¾å¤‡ç«¯éœ€è®°å½• |
| `audio_params` | æœåŠ¡å™¨æœŸæœ›çš„éŸ³é¢‘å‚æ•° |

::: warning è¶…æ—¶å¤„ç†
å¦‚æœåœ¨è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤10ç§’ï¼‰å†…æœªæ”¶åˆ°æ­£ç¡®å›å¤ï¼Œè®¤ä¸ºè¿æ¥å¤±è´¥å¹¶è§¦å‘ç½‘ç»œé”™è¯¯å›è°ƒã€‚
:::

### æ­¥éª¤4ï¼šå…¶ä»–æ¶ˆæ¯äº¤äº’

æ¡æ‰‹å®Œæˆåï¼Œè®¾å¤‡ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¹‹é—´å¯ä»¥è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ï¼š

#### æ•°æ®ç±»å‹

| æ•°æ®ç±»å‹ | æ ¼å¼ | ç”¨é€” |
|----------|------|------|
| **éŸ³é¢‘æ•°æ®** | äºŒè¿›åˆ¶å¸§ | OPUS/PCMç¼–ç çš„éŸ³é¢‘æµ |
| **æ§åˆ¶æ¶ˆæ¯** | JSONæ–‡æœ¬ | TTS/STTäº‹ä»¶ã€MCPåè®®æ¶ˆæ¯ã€èŠå¤©çŠ¶æ€ç­‰ |

### æ­¥éª¤5ï¼šå…³é—­è¿æ¥

#### ä¸»åŠ¨å…³é—­
- è®¾å¤‡/ç»ˆç«¯SDKåœ¨ç»“æŸè¯­éŸ³ä¼šè¯æ—¶ä¸»åŠ¨æ–­å¼€è¿æ¥
- è®¾å¤‡çŠ¶æ€å›åˆ°ç©ºé—²çŠ¶æ€

#### è¢«åŠ¨æ–­å¼€
- æœåŠ¡å™¨ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥
- è§¦å‘ç›¸åŒçš„å›è°ƒæµç¨‹å’ŒçŠ¶æ€é‡ç½®

### é€šä¿¡æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Server as æœåŠ¡å™¨

    Client->>Server: å»ºç«‹ WebSocket è¿æ¥
    Note right of Client: æºå¸¦è®¤è¯å¤´ä¿¡æ¯
    Server-->>Client: è¿æ¥æˆåŠŸ

    Client->>Server: å‘é€ hello æ¶ˆæ¯
    Note right of Client: åŒ…å«éŸ³é¢‘å‚æ•°å’ŒåŠŸèƒ½ç‰¹æ€§
    Server-->>Client: å“åº” hello æ¶ˆæ¯
    Note left of Server: ç¡®è®¤ä¼šè¯å‚æ•°

    Client->>Server: å‘é€å¼€å§‹ç›‘å¬æ¶ˆæ¯
    Note right of Client: å¼€å§‹éŸ³é¢‘ä¼šè¯

    Client->>Server: å‘é€éŸ³é¢‘æ•°æ® (äºŒè¿›åˆ¶)
    Server-->>Client: è¿”å›è¯†åˆ«ç»“æœ
    Server-->>Client: å‘é€ TTS éŸ³é¢‘æ•°æ®
    Note left of Server: è¯­éŸ³åˆæˆæ’­æ”¾

    Client->>Server: å‘é€åœæ­¢ç›‘å¬æ¶ˆæ¯
    Note right of Client: ç»“æŸéŸ³é¢‘ä¼šè¯

    Client->>Server: å…³é—­ WebSocket è¿æ¥
```

## WebSocket é€šä¿¡åè®®è¯¦è§£

WebSocket æ”¯æŒ **ğŸµ éŸ³é¢‘æ•°æ®å¸§**ï¼ˆäºŒè¿›åˆ¶æ–¹å¼ï¼‰ä»¥åŠ **æ–‡æœ¬å¸§**ï¼ˆJSONæ–¹å¼ï¼‰ä¼ è¾“ï¼Œä¸‹é¢åˆ†åˆ«ä»æ–‡æœ¬æ¶ˆæ¯ã€MCPåè®®ã€éŸ³é¢‘æ•°æ®è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚

### 1. ä¼šè¯æ§åˆ¶ç±»æ–‡æœ¬æ¶ˆæ¯

#### è®¾å¤‡ç«¯å‘é€æ¶ˆæ¯

##### 1. Hello æ¶ˆæ¯
è¿æ¥æˆåŠŸåï¼Œç”±è®¾å¤‡ç«¯å‘é€ï¼Œå‘ŠçŸ¥æœåŠ¡å™¨åŸºæœ¬å‚æ•°ã€‚

```json
{
  "type": "hello",
  "version": 1,
  "features": {
    "mcp": true
  },
  "transport": "websocket",
  "audio_params": {
    "format": "opus",
    "sample_rate": 16000,
    "channels": 1,
    "frame_duration": 60,
    "play_buffer_duration": 1000
  }
}
```

##### 2. Listen æ¶ˆæ¯
è¡¨ç¤ºè®¾å¤‡ç«¯å¼€å§‹ã€åœæ­¢å½•éŸ³ç›‘å¬ã€‚

```json
{
  "session_id": "session_12345",
  "type": "listen",
  "state": "start",   // "start": å¼€å§‹ç›‘å¬, "stop": ç»“æŸç›‘å¬, "detect": å”¤é†’è¯æ£€æµ‹
  "mode": "manual"    // æ”¯æŒ"manual"ã€"auto"æ¨¡å¼
}
```

**ç›‘å¬æ¨¡å¼è¯´æ˜ï¼š**
- **manual**: æ‰‹åŠ¨è§¦å‘æ¨¡å¼ï¼Œè®¾å¤‡ç«¯ä¸»åŠ¨æ§åˆ¶
- **âš¡ auto**: è‡ªåŠ¨è§¦å‘æ¨¡å¼ï¼Œå…¨åŒå·¥ï¼Œæ£€æµ‹åˆ°è¯­éŸ³åˆ™æ‰“æ–­AIè¯´è¯

##### 3. Abort æ¶ˆæ¯
ç»ˆæ­¢å½“å‰è¯´è¯ï¼ˆTTSæ’­æ”¾ï¼‰æˆ–è¯­éŸ³é€šé“ã€‚

```json
{
  "session_id": "session_12345",
  "type": "abort",
  "reason": "wake_word_detected"  // å”¤é†’è¯æ‰“æ–­æˆ–åŒå·¥æ¨¡å¼ä¸‹äººå£°æ‰“æ–­
}
```

##### 4. Wake Word Detected æ¶ˆæ¯
ç”¨äºè®¾å¤‡ç«¯å‘æœåŠ¡å™¨å‘ŠçŸ¥æ£€æµ‹åˆ°å”¤é†’è¯ã€‚

```json
{
  "session_id": "session_12345",
  "type": "listen",
  "state": "detect",
  "text": "ä½ å¥½å°æ™º"
}
```

#### æœåŠ¡ç«¯å‘é€æ¶ˆæ¯

##### 1. Hello å“åº”
æœåŠ¡å™¨ç«¯è¿”å›çš„æ¡æ‰‹ç¡®è®¤æ¶ˆæ¯ã€‚

```json
{
  "type": "hello",
  "transport": "websocket",
  "session_id": "session_12345",
  "audio_params": {
    "format": "opus",
    "sample_rate": 24000,
    "channels": 1,
    "frame_duration": 60,
    "play_buffer_duration": 1000
  }
}
```

::: info å“åº”è¦æ±‚
å¿…é¡»åŒ…å« `"type": "hello"` å’Œ `"transport": "websocket"`ï¼Œå¯èƒ½ä¼šå¸¦æœ‰ `audio_params`ï¼Œè¡¨ç¤ºæœåŠ¡å™¨æœŸæœ›çš„éŸ³é¢‘å‚æ•°ã€‚
:::

##### 2. STT æ¶ˆæ¯
è¡¨ç¤ºæœåŠ¡å™¨ç«¯è¯†åˆ«åˆ°äº†ç”¨æˆ·è¯­éŸ³ï¼ˆè¯­éŸ³è½¬æ–‡æœ¬ç»“æœï¼‰ã€‚

```json
{
  "session_id": "session_12345",
  "type": "stt",
  "text": "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·"
}
```

##### 3. LLM æƒ…æ„Ÿæ¶ˆæ¯
æœåŠ¡ç«¯æŒ‡ç¤ºè®¾å¤‡ç»ˆç«¯è°ƒæ•´è¡¨æƒ…åŠ¨ç”»/UIè¡¨è¾¾ã€‚

```json
{
  "session_id": "session_12345",
  "type": "llm",
  "emotion": "happy",
  "text": "ğŸ˜€"
}
```

**å¸¸ç”¨emojiåˆ—è¡¨ï¼š**

| Emoji | æƒ…æ„Ÿ | Emoji | æƒ…æ„Ÿ |
|-------|------|-------|------|
| ğŸ˜¶ | neutral | ğŸ˜ | loving |
| ğŸ™‚ | happy | ğŸ˜³ | embarrassed |
| ğŸ˜† | laughing | ğŸ˜² | surprised |
| ğŸ˜‚ | funny | ğŸ˜± | shocked |
| ğŸ˜” | sad | ğŸ¤” | thinking |
| ğŸ˜  | angry | ğŸ˜‰ | winking |
| ğŸ˜­ | crying | ğŸ˜ | cool |
| ğŸ˜Œ | relaxed | ğŸ¤¤ | delicious |
| ğŸ˜˜ | kissy | ğŸ˜ | confident |
| ğŸ˜´ | sleepy | ğŸ˜œ | silly |
| ğŸ™„ | confused | - | - |

##### 4. TTS æ¶ˆæ¯
æœåŠ¡å™¨TTSéŸ³é¢‘ç›¸å…³çš„çŠ¶æ€æ¶ˆæ¯ã€‚

**å¼€å§‹æ’­æ”¾ï¼š**
```json
{
  "session_id": "session_12345",
  "type": "tts",
  "state": "start"
}
```

**åœæ­¢æ’­æ”¾ï¼š**
```json
{
  "session_id": "session_12345",
  "type": "tts",
  "state": "stop"
}
```

**å¥å­å¼€å§‹ï¼š**
```json
{
  "session_id": "session_12345",
  "type": "tts",
  "state": "sentence_start",
  "text": "ä»Šå¤©å¤©æ°”å¾ˆæ£’ï¼"
}
```

### 2. MCP ç›¸å…³æ¶ˆæ¯

MCPï¼ˆModel Control Protocolï¼‰æ˜¯ç‰©è”ç½‘æ§åˆ¶çš„æ–°ä¸€ä»£åè®®ï¼Œç”¨äºè®¾å¤‡èƒ½åŠ›å‘ç°ã€çŠ¶æ€åŒæ­¥å’Œæ§åˆ¶æŒ‡ä»¤ã€‚

#### MCP äº¤äº’æµç¨‹

1. è®¾å¤‡ç»ˆç«¯åœ¨å‘é€helloæ¶ˆæ¯æ—¶åŒ…å« `"mcp": true`
2. æœåŠ¡ç«¯æ”¶åˆ°`"mcp": true`ä¼šå‘é€initialize
3. æœåŠ¡ç«¯å‘é€tool/listè¯·æ±‚
4. è®¾å¤‡ç»ˆç«¯è¿”å›å·¥å…·æè¿°
5. æœåŠ¡ç«¯ä¼šè¯è¿‡ç¨‹ä¸­è¯†åˆ«åˆ°æœ‰è°ƒç”¨å·¥å…·çš„éœ€æ±‚ï¼Œå‘è®¾å¤‡ç«¯å‘é€å·¥å…·è°ƒç”¨
6. è®¾å¤‡ç»ˆç«¯æ‰§è¡Œå·¥å…·

::: tip MCP åè®®ä¼˜åŠ¿
- **æ‰©å±•æ€§å¼º**ï¼šå¯åœ¨WebSocketã€MQTTç­‰å¤šç§åº•å±‚åè®®ä¸Šä¼ è¾“
- **æ ‡å‡†åŒ–**ï¼šå…·å¤‡æ›´å¥½çš„æ ‡å‡†åŒ–èƒ½åŠ›
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šæ”¯æŒè®¾å¤‡èƒ½åŠ›å‘ç°ã€çŠ¶æ€åŒæ­¥ã€æ§åˆ¶æŒ‡ä»¤ç­‰

è¯¦ç»†ç”¨æ³•è¯·å‚è€ƒ [**ç«¯ä¾§MCP**](https://linx.qiniu.com/docs/xrobot/mcp/hardware-mcp)ã€‚
:::

### 3. éŸ³é¢‘æ•°æ®ä¼ è¾“
éŸ³é¢‘æ•°æ®ä¼ è¾“é‡‡ç”¨äºŒè¿›åˆ¶æ–¹å¼ä¼ è¾“ï¼Œæ”¯æŒ **OPUS** å’Œ **PCM** æ ¼å¼ã€‚

- æ”¯æŒ **OPUSæ ¼å¼** å’Œ **PCMæ ¼å¼** ä¸¤ç§éŸ³é¢‘ç¼–ç 
- å½“æœåŠ¡å™¨å‘é€éŸ³é¢‘äºŒè¿›åˆ¶å¸§æ—¶ï¼Œè®¾å¤‡ç«¯è§£ç å¹¶æ’­æ”¾
- è‹¥è®¾å¤‡ç«¯æ­£åœ¨"listening"ï¼ˆå½•éŸ³ï¼‰çŠ¶æ€ï¼Œæ”¶åˆ°çš„éŸ³é¢‘å¸§ä¼šè¢«å¿½ç•¥æˆ–æ¸…ç©ºä»¥é˜²å†²çª


## ç®€åŒ–æµç¨‹ç¤ºä¾‹

1. **è®¾å¤‡ç«¯ â†’ æœåŠ¡ç«¯**ï¼ˆæ¡æ‰‹ï¼‰
   ```json
   {
     "type": "hello",
     "version": 1,
     "features": {
       "mcp": true
     },
     "transport": "websocket",
     "audio_params": {
       "format": "opus",
       "sample_rate": 16000,
       "channels": 1,
       "frame_duration": 60,
       "play_buffer_duration": 1000
     }
   }
   ```

2. **æœåŠ¡ç«¯ â†’ è®¾å¤‡ç«¯**ï¼ˆæ¡æ‰‹åº”ç­”ï¼‰
   ```json
   {
     "type": "hello",
     "transport": "websocket",
     "session_id": "xxx",
     "audio_params": {
       "format": "opus",
       "sample_rate": 16000,
       "play_buffer_duration": 1000
     }
   }
   ```

3. **è®¾å¤‡ç«¯ â†’ æœåŠ¡å™¨**ï¼ˆå¼€å§‹ç›‘å¬ï¼‰
   ```json
   {
     "session_id": "xxx",
     "type": "listen",
     "state": "start",
     "mode": "auto"
   }
   ```
   åŒæ—¶è®¾å¤‡ç«¯å¼€å§‹å‘é€äºŒè¿›åˆ¶å¸§ï¼ˆéŸ³é¢‘æ•°æ®ï¼‰ã€‚

4. **æœåŠ¡ç«¯ â†’ è®¾å¤‡ç«¯**ï¼ˆASR ç»“æœï¼‰
   ```json
   {
     "session_id": "xxx",
     "type": "stt",
     "text": "ç”¨æˆ·è¯´çš„è¯"
   }
   ```

5. **æœåŠ¡ç«¯ â†’ è®¾å¤‡ç«¯**ï¼ˆTTSå¼€å§‹ï¼‰
   ```json
   {
     "session_id": "xxx",
     "type": "tts",
     "state": "start"
   }
   ```
   æ¥ç€æœåŠ¡å™¨å‘é€äºŒè¿›åˆ¶éŸ³é¢‘å¸§ç»™è®¾å¤‡ç«¯æ’­æ”¾ã€‚

6. **æœåŠ¡ç«¯ â†’ è®¾å¤‡ç«¯**ï¼ˆTTSç»“æŸï¼‰
   ```json
   {
     "session_id": "xxx",
     "type": "tts",
     "state": "stop"
   }
   ```
   è®¾å¤‡ç«¯åœæ­¢æ’­æ”¾éŸ³é¢‘ï¼Œè‹¥æ— æ›´å¤šæŒ‡ä»¤ï¼Œåˆ™å›åˆ°ç©ºé—²çŠ¶æ€ã€‚


## é”™è¯¯å¤„ç†

### è¿æ¥å¤±è´¥

- å¦‚æœConnect()è¿”å›å¤±è´¥æˆ–åœ¨ç­‰å¾…æœåŠ¡å™¨"hello"æ¶ˆæ¯æ—¶è¶…æ—¶ï¼Œè§¦å‘ç½‘ç»œé”™è¯¯å›è°ƒ
- è®¾å¤‡ä¼šæç¤º"æ— æ³•è¿æ¥åˆ°æœåŠ¡"æˆ–ç±»ä¼¼é”™è¯¯ä¿¡æ¯

### æœåŠ¡å™¨æ–­å¼€

- å¦‚æœWebSocketå¼‚å¸¸æ–­å¼€ï¼Œå›è°ƒOnDisconnected()
- è®¾å¤‡ç»ˆç«¯å…³é—­éŸ³é¢‘å‘é€é€šé“
- åˆ‡æ¢åˆ°Idleæˆ–å…¶ä»–é‡è¯•é€»è¾‘

## å…¶ä»–æ³¨æ„äº‹é¡¹

### é‰´æƒ

- è®¾å¤‡é€šè¿‡è®¾ç½® `Authorization: Bearer <token>` æä¾›é‰´æƒï¼ŒæœåŠ¡å™¨ç«¯éœ€éªŒè¯æ˜¯å¦æœ‰æ•ˆ
- å¦‚æœä»¤ç‰Œè¿‡æœŸæˆ–æ— æ•ˆï¼ŒæœåŠ¡å™¨å¯æ‹’ç»æ¡æ‰‹æˆ–åœ¨åç»­æ–­å¼€

